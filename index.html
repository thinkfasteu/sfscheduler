<!DOCTYPE html>
<html>
<head>
    <title>FTG Tools</title>
    <link rel="stylesheet" href="./ui/styles.css">
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <script type="module" src="./main.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-brand">
                <h1>Dienstplan-System Pro</h1>
                <p>Schichtplanung</p>
            </div>
            <div class="header-actions">
                <button id="themeToggle" class="btn btn-secondary" title="Dark Mode umschalten">üåô Dark Mode</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab(event, 'staff')">Personalverwaltung</button>
            <button class="tab" onclick="showTab(event, 'availability')">Verf√ºgbarkeiten</button>
            <button class="tab" onclick="showTab(event, 'schedule')">Dienstplan</button>
            <button class="tab" onclick="showTab(event, 'vacation')">Urlaub</button>
            <button class="tab" onclick="showTab(event, 'reports')">Berichte</button>
            <button class="tab" onclick="showTab(event, 'logs')">Protokolle</button>
        </div>

        <div class="tab-content">
            <div id="staff-tab" class="section active">
                <h2>Personalverwaltung</h2>
                <div class="form-group staff-card">
                    <h3 id="staffFormTitle">Neue Arbeitskraft hinzuf√ºgen</h3>
                    <input type="hidden" id="staffIdToEdit" />
                    <div class="form-row">
                        <input type="text" id="staffName" placeholder="Name" />
                        <select id="staffType">
                            <option value="minijob">Minijob</option>
                            <option value="student">Werkstudent</option>
                            <option value="permanent">Festangestellt</option>
                        </select>
                        <input type="number" id="contractHours" placeholder="Std/Woche" />
                        <input type="number" id="typicalWorkdays" placeholder="Tage/Woche" />
                    </div>
                    <div class="form-row" id="permanentPreferredRow" style="display:none;">
                        <label>Bevorzugter Schichttyp (Festangestellte)</label>
                        <select id="permanentPreferredShift">
                            <option value="none">Keine Pr√§ferenz</option>
                            <option value="early">Fr√ºh</option>
                            <option value="midday">Mittel</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <label style="display:flex; align-items:center; gap:8px;">
                            <input type="checkbox" id="weekendPreference" />
                            <span>Bevorzugt Wochenendschichten</span>
                        </label>
                    </div>
                    <h4>Urlaubszeitr√§ume</h4>
                    <div class="form-row" style="align-items:flex-end; grid-template-columns: 1fr 1fr auto;">
                        <div><label>Von</label><input type="date" id="staffVacationStart" /></div>
                        <div><label>Bis</label><input type="date" id="staffVacationEnd" /></div>
                        <button class="btn btn-secondary" onclick="addStaffVacationPeriod()">Urlaub hinzuf√ºgen</button>
                    </div>
                    <ul id="staffVacationList"></ul>

                    <h4>Krankheitszeitr√§ume</h4>
                    <div class="form-row" style="align-items:flex-end; grid-template-columns: 1fr 1fr auto;">
                        <div><label>Von</label><input type="date" id="staffIllnessStart" /></div>
                        <div><label>Bis</label><input type="date" id="staffIllnessEnd" /></div>
                        <button class="btn btn-secondary" onclick="addStaffIllnessPeriod()">Krankmeldung hinzuf√ºgen</button>
                    </div>
                    <ul id="staffIllnessList"></ul>
                    <div class="form-row">
                        <button id="saveStaffBtn" class="btn" onclick="addStaff()">Arbeitskraft speichern</button>
                        <button id="cancelEditBtn" class="btn btn-secondary" style="display:none;" onclick="resetStaffForm()">Abbrechen</button>
                    </div>
                </div>
                <div id="staffList" class="form-row"></div>
            </div>

            <div id="availability-tab" class="section">
                <h2>Verf√ºgbarkeiten / Freiw√ºnsche</h2>
                <div class="controls form-row availability-controls">
                    <div>
                        <label>Mitarbeiter</label>
                        <select id="availabilityStaffSelect" onchange="handleAvailabilityDisplay()"></select>
                    </div>
                    <div>
                        <label>Monat</label>
                        <select id="availabilityMonth" onchange="handleAvailabilityDisplay()"></select>
                    </div>
                    <button class="btn btn-secondary" onclick="showHolidaysPopup()">Feiertage</button>
                </div>
                <div id="availabilityForm"><p>Bitte Mitarbeiter und Monat ausw√§hlen.</p></div>
            </div>

            <div id="schedule-tab" class="section">
                <h2>Dienstplan</h2>
                <div class="controls form-row" style="align-items:center; grid-template-columns: 2fr auto 1fr 1fr 1fr 1fr; gap:8px;">
                    <select id="scheduleMonth"></select>
                    <label style="display:flex; gap:6px; align-items:center;">
                        <input type="checkbox" id="studentExceptionCheckbox" />
                        <span>Kurzfristige Ausnahme zulassen (Werkstudent)</span>
                    </label>
                    <button class="btn btn-success" onclick="generateSchedule()">Dienstplan erstellen</button>
                    <button class="btn btn-danger" onclick="clearSchedule()">Plan l√∂schen</button>
                    <button class="btn" onclick="exportSchedule()">Export CSV</button>
                    <button class="btn" onclick="exportPDF()">PDF Export</button>
                    <button class="btn" onclick="printSchedule()">Drucken</button>
                </div>
                <div class="controls form-row" style="align-items:center; grid-template-columns: auto 1fr; margin-top:6px;">
                    <label style="display:flex; gap:6px; align-items:center;">
                        <input type="checkbox" id="studentFairnessCheckbox" />
                        <span>Fairness-Modus: Gew√ºnschte Arbeitstage respektieren (Werkstudenten)</span>
                    </label>
                </div>
                <div id="scheduleContent" style="overflow-x:auto;"></div>
                <div id="weekendReport" style="margin-top:16px;"></div>
                <div class="staff-card" style="margin-top:16px;">
                    <h3>Wochenend-√úberstunden Anfragen</h3>
                    <p style="color:#6c757d;">Anfragen f√ºr Wochenendschichten von Festangestellten (nur bei unbesetzbaren Schichten)</p>
                    <div id="overtimeRequestsList"></div>
                </div>
            </div>

            <div id="vacation-tab" class="section">
                <h2>Urlaub</h2>
                <div class="form-row" style="align-items:center; grid-template-columns: auto 1fr; margin-bottom:8px;">
                    <label>Jahr</label>
                    <select id="vacationYearSelect"></select>
                </div>
                <div style="overflow-x:auto;">
                    <table class="table" style="width:100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align:left;">Mitarbeiter</th>
                                <th>Urlaubsanspruch</th>
                                <th>Urlaub genommen (manuell)</th>
                                <th>√úbertrag (Vorjahr)</th>
                                <th>Urlaub geplant</th>
                                <th>Urlaub verbleibend</th>
                                <th>Krank gemeldet (Jahr)</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="vacationLedgerTable"></tbody>
                    </table>
                </div>
                <div class="form-row" style="align-items:flex-end; grid-template-columns: 1fr 1fr 1fr 1fr;">
                    <div>
                        <label>Mitarbeiter</label>
                        <select id="vacationStaffSelect"></select>
                    </div>
                    <div><label>Von</label><input type="date" id="vacationStart" /></div>
                    <div><label>Bis</label><input type="date" id="vacationEnd" /></div>
                    <button class="btn btn-secondary" onclick="addVacationPeriod()">Urlaub hinzuf√ºgen</button>
                </div>
                <ul id="vacationList"></ul>

                <hr style="margin:16px 0;"/>
                <h3>Weitere Mitarbeitende (nur Urlaube)</h3>
                <div class="form-group staff-card">
                    <div class="form-row" style="grid-template-columns: 1fr auto; align-items:end;">
                        <div>
                            <label>Name</label>
                            <input type="text" id="otherStaffName" placeholder="Name" />
                        </div>
                        <button class="btn" onclick="addOtherStaff()">Mitarbeitende speichern</button>
                    </div>
                    <h4>Urlaubszeitr√§ume</h4>
                    <div class="form-row" style="grid-template-columns: 1fr 1fr auto; align-items:end;">
                        <div>
                            <label>Von</label>
                            <input type="date" id="otherVacationStart" />
                        </div>
                        <div>
                            <label>Bis</label>
                            <input type="date" id="otherVacationEnd" />
                        </div>
                        <button class="btn btn-secondary" onclick="addOtherVacationPeriod()">Urlaub hinzuf√ºgen</button>
                    </div>
                    <ul id="otherVacationList"></ul>
                </div>
                <div id="otherStaffList" class="form-row"></div>
            </div>

            <div id="reports-tab" class="section">
                <h2>Berichte</h2>
                <div class="controls form-row" style="align-items:center; grid-template-columns: auto 1fr; gap:8px;">
                    <label>Monat</label>
                    <select id="reportsMonth"></select>
                </div>
                <div style="margin-top:12px;">
                    <h3>Stunden√ºbersicht f√ºr <span id="hoursReportMonthLabel"></span></h3>
                    <div style="overflow-x:auto;">
                        <table class="table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align:left;">Mitarbeiter</th>
                                    <th>Typ</th>
                                    <th>Stunden</th>
                                    <th>√úberstunden</th>
                                    <th>Verdienst (ca.)</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="monthlyHoursReport"></tbody>
                        </table>
                    </div>
                </div>
                <div style="margin-top:18px;">
                    <h3>Werkstudent Wochen√ºbersicht</h3>
                    <div style="overflow-x:auto;">
                        <table class="table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align:left;">Name</th>
                                    <th>KW</th>
                                    <th>Stunden</th>
                                    <th>WE/Nacht-Anteil %</th>
                                    <th>Ausnahme (WS)</th>
                                </tr>
                            </thead>
                            <tbody id="studentWeeklyReport"></tbody>
                        </table>
                    </div>
                </div>
                <div style="margin-top:18px;">
                    <h3>√úberstunden (Festangestellte) ‚Äì <span id="otReportMonthLabel"></span></h3>
                    <div style="overflow-x:auto;">
                        <table class="table" style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr>
                                    <th style="text-align:left;">Name</th>
                                    <th>KW</th>
                                    <th>√úberstunden (h)</th>
                                </tr>
                            </thead>
                            <tbody id="overtimeCreditsReport"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="logs-tab" class="section">
                <h2>√Ñnderungsprotokoll</h2>
                <div style="overflow-x:auto;">
                    <table class="table" style="width:100%; border-collapse:collapse;">
                        <thead>
                            <tr>
                                <th style="text-align:left;">Zeitstempel</th>
                                <th>Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="auditLogTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</body>
<!-- PDF export libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
<!-- Holidays Modal -->
<div id="holidaysModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:1000;">
    <div class="modal-content" style="background:#fff; width: 600px; max-width: 90vw; margin: 10vh auto; padding: 16px; border-radius: 8px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Feiertage verwalten</h3>
            <button class="btn btn-secondary" onclick="document.getElementById('holidaysModal').style.display='none'">Schlie√üen</button>
        </div>
        <div class="form-row" style="margin-top:10px; grid-template-columns: 1fr 2fr 1fr; align-items:end;">
            <div>
                <label>Jahr</label>
                <select id="holidaysYear"></select>
            </div>
            <div style="display:flex; gap:8px; align-items:end;">
                <div>
                    <label>Datum</label>
                    <input type="date" id="holidayDate" />
                </div>
                <div>
                    <label>Name</label>
                    <input type="text" id="holidayName" placeholder="Feiertag" />
                </div>
            </div>
            <div>
                <button class="btn" onclick="addHoliday()">Hinzuf√ºgen</button>
            </div>
        </div>
        <ul id="holidaysList" style="margin-top:12px;"></ul>
        <hr/>
        <div>
            <h4>Vorlesungszeiten (ICS)</h4>
            <p>Optional: URL eines ICS-Kalenders mit Vorlesungs- und vorlesungsfreien Zeiten.</p>
            <div class="form-row" style="grid-template-columns: 1fr auto; align-items: end;">
                <input type="url" id="icsUrlInput" placeholder="https://‚Ä¶/academic.ics" />
                <button class="btn" onclick="addIcsSource()">Hinzuf√ºgen</button>
            </div>
            <ul id="icsSourcesList" style="margin-top:8px;"></ul>
            <div style="margin-top:8px;">
                <button class="btn btn-secondary" onclick="refreshAcademicTerms()">Vorlesungszeiten laden/aktualisieren</button>
            </div>
        </div>
    </div>
</div>
</div>

<!-- Assignment/Swap Modal -->
<div id="swapModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:1000;">
    <div class="modal-content" style="background:#fff; width: 700px; max-width: 95vw; margin: 8vh auto; padding: 16px; border-radius: 8px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="swapTitle">Zuweisung</h3>
            <button class="btn btn-secondary" onclick="document.getElementById('swapModal').style.display='none'">Schlie√üen</button>
        </div>
        <div id="swapDetail" style="margin:8px 0 12px 0;"></div>
        <div class="form-row" style="grid-template-columns: 1fr 1fr; align-items:start;">
            <div>
                <label>Schicht</label>
                <select id="swapShiftSelect"></select>
                <div id="currentAssignment" style="margin-top:8px; color:#677684;"></div>
            </div>
            <div>
                <label>Kandidaten</label>
                <select id="swapStaffSelect"></select>
                <div id="candidateNotes" style="margin-top:8px; font-size:0.9em; color:#677684;"></div>
                        <div id="includePermanentsRow" style="display:none; margin-top:8px;">
                            <label style="display:flex; gap:8px; align-items:center;">
                                <input type="checkbox" id="includePermanentsCheckbox" />
                                <span>Auch Festangestellte f√ºr Wochenendschichten ber√ºcksichtigen</span>
                            </label>
                        </div>
                <div id="consentRow" style="display:none; margin-top:8px;">
                    <label style="display:flex; gap:8px; align-items:center;">
                        <input type="checkbox" id="consentCheckbox" />
                        <span id="consentLabel">Zustimmung f√ºr diesen Tag anfragen</span>
                    </label>
                    <div id="consentHint" style="margin-top:4px; font-size:0.85em; color:#8a97a6; display:none;">
                        Bei Zustimmung werden diese Wochenendstunden als √úberstunden gez√§hlt (au√üerhalb des Wochenziels).
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-top:14px; display:flex; gap:8px; justify-content:flex-end;">
            <button id="executeSwapBtn" class="btn btn-secondary">Wechseln</button>
            <button id="executeAssignBtn" class="btn btn-success">Zuweisen</button>
        </div>
        <div id="assignHint" style="margin-top:8px; font-size:0.85em; color:#677684;">
            Hinweis: Es werden nur f√ºr den Tag zul√§ssige Schichten angeboten (Wochenende/Feiertag/werktags). Zuweisungen werden automatisch validiert.
        </div>
    </div>
</div>
</html>
</html>
<!-- Search & Assign Modal -->
<div id="searchModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); z-index:1000;">
    <div class="modal-content" style="background:#fff; width: 740px; max-width: 95vw; margin: 8vh auto; padding: 16px; border-radius: 8px;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 id="searchTitle">Suchen & Zuweisen</h3>
            <button class="btn btn-secondary" onclick="document.getElementById('searchModal').style.display='none'">Schlie√üen</button>
        </div>
        <div id="searchDetail" style="margin:8px 0 12px 0;"></div>
        <div class="form-row" style="grid-template-columns: 1fr 1fr; align-items:start;">
            <div>
                <label>Schicht</label>
                <select id="searchShiftSelect"></select>
            </div>
            <div>
                <label>Mitarbeiter</label>
                <input type="text" id="searchFilterInput" placeholder="Suchen (Name, Rolle)" />
                <select id="searchStaffSelect" style="margin-top:6px;"></select>
                <div id="searchCandidateNotes" style="margin-top:8px; font-size:0.9em; color:#677684;"></div>
                <div id="searchIncludePermanentsRow" style="display:none; margin-top:8px;">
                    <label style="display:flex; gap:8px; align-items:center;">
                        <input type="checkbox" id="searchIncludePermanentsCheckbox" />
                        <span>Auch Festangestellte f√ºr Wochenendschichten ber√ºcksichtigen</span>
                    </label>
                </div>
                <div id="searchConsentRow" style="display:none; margin-top:8px;">
                    <label style="display:flex; gap:8px; align-items:center;">
                        <input type="checkbox" id="searchConsentCheckbox" />
                        <span id="searchConsentLabel">Zustimmung f√ºr diesen Tag anfragen</span>
                    </label>
                    <div id="searchConsentHint" style="margin-top:4px; font-size:0.85em; color:#8a97a6; display:none;">
                        Bei Zustimmung werden diese Wochenendstunden als √úberstunden gez√§hlt (au√üerhalb des Wochenziels).
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-top:14px; display:flex; gap:8px; justify-content:flex-end;">
            <button id="executeSearchAssignBtn" class="btn btn-success">Zuweisen</button>
        </div>
        <div style="margin-top:8px; font-size:0.85em; color:#677684;">
            Hinweis: Kandidatenliste basiert auf Regeln und Verf√ºgbarkeiten; Blocker werden als Hinweis angezeigt und verhindern die Zuweisung.
        </div>
    </div>
</div>
