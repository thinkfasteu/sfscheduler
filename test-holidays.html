<!DOCTYPE html>
<html>
<head>
    <title>Holiday Functionality Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .test-button { background: #007bff; color: white; padding: 8px 16px; margin: 5px; border: none; cursor: pointer; }
        .test-button:hover { background: #0056b3; }
        .status { font-weight: bold; margin: 5px 0; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        iframe { border: 1px solid #ddd; margin-top: 10px; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Holiday Functionality Debugging</h1>
    
    <div class="test-section">
        <h2>Quick Tests</h2>
        <button class="test-button" onclick="runHolidayDebug()">Debug Holiday Functions</button>
        <button class="test-button" onclick="testHolidayAPI()">Test API Call</button>
        <button class="test-button" onclick="testHolidayPopup()">Test Popup</button>
        <button class="test-button" onclick="clearConsole()">Clear Console</button>
        
        <div id="testResults"></div>
    </div>
    
    <div class="test-section">
        <h2>App Integration Test</h2>
        <p>The main app is loaded below. Open browser console to see debug output.</p>
        <p><strong>Test Steps:</strong></p>
        <ol>
            <li>Click "Debug Holiday Functions" above to check all components</li>
            <li>Click the "Feiertage" button in the app below</li>
            <li>Check console for any errors or missing components</li>
        </ol>
        <iframe id="appFrame" src="http://localhost:8080" width="100%" height="500"></iframe>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            results.appendChild(div);
            console.log(`[HOLIDAY-TEST] ${message}`);
        }

        function clearConsole() {
            document.getElementById('testResults').innerHTML = '';
            console.clear();
            log('Console cleared');
        }

        async function runHolidayDebug() {
            log('Running holiday debug on main app...', 'info');
            
            const frame = document.getElementById('appFrame');
            try {
                const frameWindow = frame.contentWindow;
                
                // Wait for app to be loaded
                if (!frameWindow.appState) {
                    log('App not fully loaded yet, waiting...', 'warning');
                    setTimeout(runHolidayDebug, 1000);
                    return;
                }
                
                // Check holiday button
                const holidayBtn = frameWindow.document.getElementById('showHolidaysBtn');
                if (holidayBtn) {
                    log('✓ Holiday button found: ' + holidayBtn.textContent, 'success');
                } else {
                    log('✗ Holiday button NOT found', 'error');
                }
                
                // Check window functions
                if (frameWindow.showHolidaysPopup) {
                    log('✓ window.showHolidaysPopup available', 'success');
                } else {
                    log('✗ window.showHolidaysPopup NOT available', 'error');
                }
                
                // Check AppUI
                if (frameWindow.appUI?.showHolidaysPopup) {
                    log('✓ appUI.showHolidaysPopup available', 'success');
                } else {
                    log('✗ appUI.showHolidaysPopup NOT available', 'error');
                }
                
                // Check services
                if (frameWindow.__services?.holiday) {
                    log('✓ Holiday service available', 'success');
                    if (frameWindow.__services.holiday.fetchHolidaysForYear) {
                        log('✓ fetchHolidaysForYear method available', 'success');
                    } else {
                        log('✗ fetchHolidaysForYear method NOT available', 'error');
                    }
                } else {
                    log('✗ Holiday service NOT available', 'error');
                }
                
                // Check modal
                const modal = frameWindow.document.getElementById('holidaysModal');
                if (modal) {
                    log('✓ Holiday modal found', 'success');
                } else {
                    log('✗ Holiday modal NOT found', 'error');
                }
                
                // Inject debug script into the frame
                const script = frameWindow.document.createElement('script');
                script.src = 'debug-holidays.js';
                frameWindow.document.head.appendChild(script);
                log('Debug script injected into app frame', 'info');
                
            } catch (e) {
                log('Error accessing app frame: ' + e.message, 'error');
            }
        }

        async function testHolidayAPI() {
            log('Testing holiday API directly...', 'info');
            
            try {
                const url = 'https://date.nager.at/api/v3/PublicHolidays/2025/DE';
                log('Fetching from: ' + url, 'info');
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}: ${response.statusText}`);
                }
                
                const holidays = await response.json();
                log(`✓ API call successful - ${holidays.length} holidays received`, 'success');
                
                // Show first few holidays
                const sample = holidays.slice(0, 3).map(h => `${h.date}: ${h.localName}`).join(', ');
                log(`Sample holidays: ${sample}`, 'info');
                
            } catch (e) {
                log(`✗ API call failed: ${e.message}`, 'error');
            }
        }

        async function testHolidayPopup() {
            log('Testing holiday popup...', 'info');
            
            const frame = document.getElementById('appFrame');
            try {
                const frameWindow = frame.contentWindow;
                
                if (!frameWindow.appState) {
                    log('App not loaded yet', 'warning');
                    return;
                }
                
                const holidayBtn = frameWindow.document.getElementById('showHolidaysBtn');
                if (holidayBtn) {
                    log('Clicking holiday button...', 'info');
                    holidayBtn.click();
                    
                    // Check if modal opened
                    setTimeout(() => {
                        const modal = frameWindow.document.getElementById('holidaysModal');
                        if (modal && modal.classList.contains('open')) {
                            log('✓ Holiday modal opened successfully', 'success');
                        } else {
                            log('✗ Holiday modal did not open', 'error');
                        }
                    }, 500);
                } else {
                    log('✗ Holiday button not found', 'error');
                }
                
            } catch (e) {
                log('Error testing popup: ' + e.message, 'error');
            }
        }

        // Auto-run debug when page loads
        window.addEventListener('load', () => {
            setTimeout(runHolidayDebug, 2000);
        });
    </script>
</body>
</html>